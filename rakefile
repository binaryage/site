# coding: utf-8
require 'colored2'

require_relative './.lib/utils.rb'
require_relative './.lib/site.rb'
require_relative './.lib/workspace.rb'
require_relative './.lib/repo.rb'
require_relative './.lib/build.rb'
require_relative './.lib/store.rb'

## CONFIG ###################################################################################################################

BASE_PORT = 4101
MAIN_PORT = 80 # we will need admin rights to bind to this port when running `rake proxy`
LOCAL_DOMAIN = 'binaryage.org' # this domain is for testing to be set in /etc/hosts, see `rake hosts`

MIN_NPM_VERSION = '1.1.18'
MIN_GEM_VERSION = '1.8.23'

CDN_URL = 'https://static.binaryage.com/'

ROOT = File.expand_path('.')

STAGE_DIR = File.join(ROOT, '_stage')
SERVE_DIR = File.join(STAGE_DIR, 'serve')
BUILD_DIR = File.join(STAGE_DIR, 'build')
STORE_DIR = File.join(STAGE_DIR, 'store')

## SITES ####################################################################################################################

$dirs = %w(
www blog support
totalfinder-web totalspaces-web
asepsis-web totalterminal-web visor
firequery firerainbow firelogger xrefresh
drydrop hints restatic-web test-web hodlwallet)

$sites = $dirs.each_with_index.collect { |dir, index| Site.new(File.join(ROOT, dir), BASE_PORT+index, LOCAL_DOMAIN) }

## TASKS ####################################################################################################################

desc 'install npm dependencies'
task :init_npm do
  unless Gem::Version.new(`npm --version`) >= Gem::Version.new(MIN_NPM_VERSION)
    die "install npm (>=v#{MIN_NPM_VERSION}) => http://npmjs.org"
  end
  sys('rm -rf node_modules')
  sys('npm cache clean')
  sys('npm install')
end

desc 'install gem dependencies'
task :init_gem do
  unless Gem::Version.new(`gem --version`) >= Gem::Version.new(MIN_GEM_VERSION)
    die "install rubygems (>=v#{MIN_GEM_VERSION}, no sudo, consider rvm) => http://rubygems.org, http://beginrescueend.com"
  end
  sys('bundle install')
end

desc 'init workspace - needs special care'
task :init => [:init_gem, :init_npm] do
  init_workspace($sites, get_writable_git_url)
end

desc 'clean stage'
task :clean do
  sys("rm -rf \"#{SERVE_DIR}\"")
  sys("rm -rf \"#{STAGE_DIR}\"")
end

desc 'reset workspace to match remote changes - this will destroy your local changes!!!'
task :reset => [:clean] do
  reset_workspace($sites)
end

desc 'prints info how to setup /etc/hosts'
task :hosts do
  puts prepare_hosts_template($sites)
end

desc 'generate proxy config (for nginx)'
task :proxy_config do
  puts prepare_proxy_config($sites)
end

desc 'start proxy server'
task :proxy do
  trap('INT') do
    exit 10
  end
  config_path = File.join(STAGE_DIR, '.proxy.config')
  sys("rake -s proxy_config > \"#{config_path}\"")
  sys("sudo nginx -c \"#{config_path}\"")
end

desc 'run dev server'
task :serve do
  all_names = sites_subdomains($sites).join(',')
  what = ENV['what'] || die("specify coma separated list of sites to serve, or `rake serve what=all`, full list:\n`rake serve what=#{all_names}`")
  if what=='all'
    what = all_names
  end
  names = clean_names(what.split(','))

  puts "note: #{'make sure you have'.green} #{'/etc/hosts'.yellow} #{'properly configured, see'.green} #{'rake hosts'.blue}"
  serve_sites($sites, SERVE_DIR, names)
end

desc 'build site'
task :build do
  what = (ENV['what'] || sites_subdomains($sites).join(','))
  names = clean_names(what.split(','))

  # TODO: we could bring in more stuff from env
  build_opts = {
      :stage => ENV['stage'] || BUILD_DIR,
      :dev_mode => false,
      :clean_stage => true,
      :busters => true,
      :cdn => true,
      :cdn_url => CDN_URL
  }

  build_sites($sites, build_opts, names)
end

desc 'generate store template zip' # see https://springboard.fastspring.com/site/configuration/template/doc/templateOverview.xml
task :store do
  build_store($sites.first, {:stage => STORE_DIR,
                             :zip_path => 'store-template.zip'})
end

desc 'inspect the list of sites currently registered'
task :inspect do
  puts $sites
end

task :default => :serve
